name: Claude PR Review
on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: claude-pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    if: >-
      github.event.pull_request.base.ref != 'stage' &&
      github.event.pull_request.base.ref != 'master' &&
      !startsWith(github.event.pull_request.base.ref, 'release') &&
      !contains(toJSON(github.event.pull_request.labels.*.name), 'sync')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log review start
        run: |
          echo "========================================="
          echo "ğŸ” Claude PR Review ì‹œì‘"
          echo "========================================="
          echo "ğŸ“Œ PR: #${{ github.event.pull_request.number }}"
          echo "ğŸ“ ì œëª©: ${{ github.event.pull_request.title }}"
          echo "ğŸ‘¤ ì‘ì„±ì: ${{ github.event.pull_request.user.login }}"
          echo "ğŸ”€ ë¸Œëœì¹˜: ${{ github.head_ref }} â†’ ${{ github.base_ref }}"
          echo "ğŸ“Š ë³€ê²½: +${{ github.event.pull_request.additions }} / -${{ github.event.pull_request.deletions }}"
          echo "========================================="

      - name: Get incremental diff
        if: github.event.action == 'synchronize'
        id: incremental
        run: |
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.event.after }}"
          echo "Incremental diff: ${BEFORE}..${AFTER}"
          DIFF=$(git diff "${BEFORE}..${AFTER}" -- . ':!pnpm-lock.yaml' ':!*.d.ts' ':!.github/')
          {
            echo "diff<<DIFF_EOF"
            echo "$DIFF"
            echo "DIFF_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run Claude PR Review (full)
        if: github.event.action != 'synchronize'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            PR #${{ github.event.pull_request.number }} (${{ github.head_ref }} â†’ ${{ github.base_ref }})ì˜ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”.
            .claude/rules/ì˜ ë¦¬ë·° ê·œì¹™ì„ ë”°ë¼ ë¦¬ë·°í•©ë‹ˆë‹¤.
            `mcp__github_inline_comment__create_inline_comment`ìœ¼ë¡œ ì¸ë¼ì¸ ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê¸°ì„¸ìš”.

            ## í•„ìˆ˜ íš¨ìœ¨ ê·œì¹™
            - TodoWrite ì‚¬ìš© ê¸ˆì§€
            - ë…ë¦½ì ì¸ ë„êµ¬ í˜¸ì¶œì€ ë°˜ë“œì‹œ í•œ í„´ì— ë³‘ë ¬ë¡œ ì‹¤í–‰ (íŒŒì¼ ì½ê¸°, ì¸ë¼ì¸ ì½”ë©˜íŠ¸ ì‘ì„± ë“±)
            - ë³€ê²½ëœ íŒŒì¼ ìœ í˜•ì— í•´ë‹¹í•˜ëŠ” ìŠ¤í‚¬ë§Œ ì½ê¸° (í…ŒìŠ¤íŠ¸ íŒŒì¼ ì—†ìœ¼ë©´ í…ŒìŠ¤íŠ¸ ìŠ¤í‚¬ ì½ì§€ ì•ŠìŒ)
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh api:*)"

      - name: Run Claude PR Review (synchronize)
        if: github.event.action == 'synchronize' && steps.check_skip.outputs.skip != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            PR #${{ github.event.pull_request.number }}ì— ìƒˆë¡œìš´ ì»¤ë°‹ì´ pushë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ incremental-diffì— ëª…ì‹œë˜ì–´ìˆëŠ” **ìƒˆë¡œ ì¶”ê°€ëœ ë³€ê²½ì‚¬í•­ë§Œ** ë¦¬ë·°í•´ì£¼ì„¸ìš”.
            .claude/rules/ì˜ ë¦¬ë·° ê·œì¹™ì„ ë”°ë¼ ë¦¬ë·°í•©ë‹ˆë‹¤.
            `mcp__github_inline_comment__create_inline_comment`ìœ¼ë¡œ ì¸ë¼ì¸ ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê¸°ì„¸ìš”.

            ## í•„ìˆ˜ íš¨ìœ¨ ê·œì¹™
            - TodoWrite ì‚¬ìš© ê¸ˆì§€
            - ë…ë¦½ì ì¸ ë„êµ¬ í˜¸ì¶œì€ ë°˜ë“œì‹œ í•œ í„´ì— ë³‘ë ¬ë¡œ ì‹¤í–‰ (íŒŒì¼ ì½ê¸°, ì¸ë¼ì¸ ì½”ë©˜íŠ¸ ì‘ì„± ë“±)
            - ë³€ê²½ëœ íŒŒì¼ ìœ í˜•ì— í•´ë‹¹í•˜ëŠ” ìŠ¤í‚¬ë§Œ ì½ê¸° (í…ŒìŠ¤íŠ¸ íŒŒì¼ ì—†ìœ¼ë©´ í…ŒìŠ¤íŠ¸ ìŠ¤í‚¬ ì½ì§€ ì•ŠìŒ)

            <incremental-diff>
            ${{ steps.incremental.outputs.diff }}
            </incremental-diff>
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh api:*)"

      - name: Log review complete
        if: always()
        run: |
          echo "========================================="
          echo "âœ… Claude PR Review ì™„ë£Œ"
          echo "========================================="
